<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herbalife Distributor Pricing</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary-green:#8BC34A;--dark-green:#689F38;--light-green:#DCEDC8;--bg-light:#F5F5F5;--bg-dark:#1a1a1a;--card-light:#fff;--card-dark:#2d2d2d;--text-light:#212121;--text-dark:#f5f5f5;--border-light:#e0e0e0;--border-dark:#444}
        body{font-family:'Segoe UI',sans-serif;background:var(--bg-light);color:var(--text-light);transition:all 0.3s}
        body.dark-mode{background:var(--bg-dark);color:var(--text-dark)}
        .header{background:linear-gradient(135deg,var(--primary-green),var(--dark-green));color:#fff;padding:15px 20px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        .header h1{font-size:26px;margin-bottom:8px}
        .header-controls{display:flex;gap:15px;align-items:center;flex-wrap:wrap;margin-top:15px}
        .distributor-input{display:flex;gap:10px;flex:1;min-width:250px}
        .distributor-input input{flex:1;padding:10px;border:none;border-radius:5px;font-size:14px}
        .dark-mode-toggle{display:flex;align-items:center;gap:10px}
        .toggle-switch{position:relative;width:50px;height:24px;background:rgba(255,255,255,0.3);border-radius:12px;cursor:pointer}
        .toggle-switch.active{background:rgba(255,255,255,0.5)}
        .toggle-slider{position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:all 0.3s}
        .toggle-switch.active .toggle-slider{left:28px}
        .nav{background:var(--card-light);padding:12px 15px;display:flex;gap:12px;overflow-x:auto}
        body.dark-mode .nav{background:var(--card-dark)}
        .nav-btn{padding:8px 16px;background:var(--light-green);border:none;border-radius:5px;cursor:pointer;font-weight:600;color:var(--dark-green);white-space:nowrap;font-size:13px}
        .nav-btn:hover,.nav-btn.active{background:var(--primary-green);color:#fff}
        .container{max-width:1400px;margin:0 auto;padding:15px}
        .page{display:none}.page.active{display:block}
        .table-container{background:var(--card-light);border-radius:10px;padding:15px;overflow-x:auto;margin-bottom:15px}
        body.dark-mode .table-container{background:var(--card-dark)}
        table{width:100%;border-collapse:collapse;min-width:1100px}
        th{background:var(--primary-green);color:#fff;padding:10px 8px;text-align:left;font-weight:600;font-size:13px}
        td{padding:8px 6px;border-bottom:1px solid var(--border-light)}
        body.dark-mode td{border-bottom:1px solid var(--border-dark)}
        input[type="text"],input[type="number"],select{width:100%;padding:8px;border:1px solid var(--border-light);border-radius:5px;font-size:13px;background:var(--bg-light);color:var(--text-light)}
        body.dark-mode input,body.dark-mode select{background:var(--bg-dark);color:var(--text-dark);border-color:var(--border-dark)}
        .product-input-wrapper{position:relative;width:100%}
        .product-dropdown-btn{position:absolute;right:5px;top:50%;transform:translateY(-50%);background:var(--primary-green);color:#fff;border:none;border-radius:3px;padding:4px 8px;cursor:pointer;font-size:12px;z-index:10}
        .product-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--card-light);border:1px solid var(--border-light);border-radius:5px;z-index:1000;max-height:300px;overflow-y:auto;display:none;margin-top:5px}
        body.dark-mode .product-dropdown{background:var(--card-dark);border-color:var(--border-dark)}
        .product-dropdown.active{display:block}
        .product-category{padding:10px 12px;background:var(--primary-green);color:#fff;font-weight:600;font-size:12px}
        .product-item{padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--border-light);font-size:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px}
        .product-item:hover{background:var(--light-green);color:var(--dark-green)}
        .product-item-prices{display:flex;gap:6px;flex-wrap:wrap}
        .price-tag{font-size:10px;background:#e8f5e9;color:#388e3c;padding:1px 5px;border-radius:3px;font-weight:600;white-space:nowrap}
        .price-tag.mrp{background:#e3f2fd;color:#1565c0}
        .btn-delete{background:#f44336;color:#fff;padding:6px 12px;border:none;border-radius:5px;cursor:pointer;font-size:12px}
        .btn-add{background:var(--primary-green);color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:13px;font-weight:600;margin-top:10px}
        .btn-save{background:#2196F3;color:#fff;padding:12px 30px;border:none;border-radius:5px;cursor:pointer;font-size:15px;font-weight:600;margin-top:12px;width:100%}
        .bill-name-section{background:var(--card-light);border-radius:10px;padding:15px;margin-bottom:15px}
        body.dark-mode .bill-name-section{background:var(--card-dark)}
        .bill-name-input label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark-green)}
        .bills-container{display:grid;gap:15px}
        .bill-card{background:var(--card-light);border-radius:10px;padding:18px;border-left:5px solid var(--primary-green)}
        body.dark-mode .bill-card{background:var(--card-dark)}
        .bill-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px;padding-bottom:12px;border-bottom:2px solid var(--border-light)}
        .bill-date{font-size:12px;color:#999;font-style:italic}
        .bill-actions{display:flex;gap:10px;flex-wrap:wrap}
        .btn-view,.btn-download,.btn-delete-bill{padding:8px 16px;border:none;border-radius:5px;cursor:pointer;font-size:13px;font-weight:600}
        .btn-view{background:var(--primary-green);color:#fff}
        .btn-download{background:#2196F3;color:#fff}
        .btn-delete-bill{background:#f44336;color:#fff}
        .bill-items{margin:12px 0}
        .bill-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border-light);font-size:13px}
        .bill-item-name{font-weight:600;flex:1}
        .bill-summary{margin-top:20px;padding-top:15px;border-top:2px solid var(--primary-green)}
        .bill-summary-row{display:flex;justify-content:space-between;padding:8px 0;font-size:15px;font-weight:600}
        .search-bar{margin-bottom:15px}
        .search-bar input{width:100%;padding:15px;border:1px solid var(--border-light);border-radius:10px;font-size:16px;background:var(--card-light)}
        .summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:15px}
        .summary-card{background:var(--card-light);border-radius:10px;padding:20px;text-align:center}
        body.dark-mode .summary-card{background:var(--card-dark)}
        .summary-card h3{color:var(--primary-green);font-size:16px;margin-bottom:10px}
        .summary-card .value{font-size:32px;font-weight:bold;color:var(--dark-green)}
        .action-buttons{display:flex;gap:15px;margin-top:20px;flex-wrap:wrap}
        .action-buttons button{flex:1;min-width:150px}
        .btn-export{background:#4CAF50;color:#fff;padding:15px 30px;border:none;border-radius:5px;cursor:pointer;font-size:16px;font-weight:600}
        .btn-print{background:#FF9800;color:#fff;padding:15px 30px;border:none;border-radius:5px;cursor:pointer;font-size:16px;font-weight:600}
        .empty-state{text-align:center;padding:60px 20px;color:#999}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5)}
        .modal.active{display:flex;align-items:center;justify-content:center}
        .modal-content{background:var(--card-light);padding:25px;border-radius:10px;max-width:800px;max-height:80vh;overflow-y:auto;width:90%}
        body.dark-mode .modal-content{background:var(--card-dark)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid var(--border-light)}
        .modal-header h2{color:var(--dark-green);margin:0}
        .close-btn{font-size:28px;font-weight:bold;color:#999;cursor:pointer;background:0;border:0;padding:0}
        .modal-bill-item{padding:15px;background:var(--bg-light);border-radius:5px;margin-bottom:10px}
        body.dark-mode .modal-bill-item{background:var(--bg-dark)}
        .modal-bill-item h4{color:var(--dark-green);margin:0 0 10px 0;font-size:16px}
        .item-detail{display:flex;justify-content:space-between;margin:5px 0;font-size:13px}
        .loss-value{color:#d32f2f;font-weight:600}
        .success-message{position:fixed;top:20px;right:20px;background:var(--primary-green);color:#fff;padding:15px 25px;border-radius:5px;z-index:9999;max-width:300px}
        .watermark{position:fixed;bottom:10px;right:10px;background:rgba(139,195,74,0.1);padding:5px 12px;border-radius:15px;font-size:11px;color:var(--dark-green);z-index:999}
        /* controls bar */
        .controls-bar{background:var(--card-light);border-radius:10px;padding:15px 18px;margin-bottom:15px;display:flex;gap:24px;align-items:flex-end;flex-wrap:wrap}
        body.dark-mode .controls-bar{background:var(--card-dark)}
        .ctrl-group{display:flex;flex-direction:column;gap:4px}
        .ctrl-group label{font-weight:600;color:var(--dark-green);font-size:13px}
        .ctrl-group input,.ctrl-group select{width:auto;min-width:120px;padding:8px;border:1px solid var(--border-light);border-radius:5px;font-size:13px}
        .ctrl-notice{font-size:11px;color:#888;font-style:italic;margin-bottom:2px}
        /* tier level badge */
        .tier-badge{display:inline-block;font-size:11px;background:var(--light-green);color:var(--dark-green);padding:2px 7px;border-radius:4px;font-weight:700;margin-left:6px}
        /* automode */
        .automode-row{display:flex;align-items:center;gap:10px;margin-top:4px}
        .automode-toggle{position:relative;width:50px;height:24px;background:#ccc;border-radius:12px;cursor:pointer;flex-shrink:0}
        .automode-toggle.active{background:var(--primary-green)}
        .automode-slider{position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:all 0.3s}
        .automode-toggle.active .automode-slider{left:28px}
        .automode-status{font-size:12px;color:#888}
        /* billing warning */
        .billing-warning{background:#fff8e1;border:1px solid #ffe082;border-radius:6px;padding:10px 14px;margin-bottom:12px;font-size:12px;color:#7a6000;font-style:italic}
        body.dark-mode .billing-warning{background:#2a2200;border-color:#4a3800;color:#ffd54f}
        .modal-billing-warning{background:#fff8e1;border:1px solid #ffe082;border-radius:6px;padding:10px 14px;margin-bottom:15px;font-size:12px;color:#7a6000;font-style:italic}
        body.dark-mode .modal-billing-warning{background:#2a2200;border-color:#4a3800;color:#ffd54f}
        /* buy-price auto-filled */
        .buy-price.auto-filled{border-color:var(--primary-green)!important;background:rgba(139,195,74,0.08)!important}
    </style>
</head>
<body>
<div class="header">
    <h1>ğŸŒ¿ Herbalife Distributor Pricing App</h1>
    <div class="header-controls">
        <div class="distributor-input">
            <input type="text" id="distributorName" placeholder="Enter Distributor Name">
        </div>
        <div class="dark-mode-toggle">
            <span>â˜€ï¸</span>
            <div class="toggle-switch" id="darkModeToggle" onclick="toggleDarkMode()"><div class="toggle-slider"></div></div>
            <span>ğŸŒ™</span>
        </div>
    </div>
    <div id="currentDistributor" style="margin-top:10px;font-size:14px;"></div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="showPage('input')">ğŸ“ Product Input</button>
    <button class="nav-btn" onclick="showPage('saved')">ğŸ’¾ Saved Bills</button>
    <button class="nav-btn" onclick="showPage('summary')">ğŸ“Š Summary</button>
</div>

<div class="container">
    <div id="inputPage" class="page active">
        <div class="bill-name-section">
            <div class="bill-name-input">
                <label>ğŸ“‹ Bill Name:</label>
                <input type="text" id="billName" placeholder="e.g., January Sales">
            </div>
        </div>

        <!-- Controls Bar -->
        <div class="controls-bar">
            <!-- Distributor Level -->
            <div class="ctrl-group">
                <label>ğŸ·ï¸ Your Distributor Level</label>
                <span class="ctrl-notice">*Sets your buy price from Herbalife's official price list</span>
                <select id="distLevel" onchange="onLevelChange()">
                    <option value="retail">Retail Price</option>
                    <option value="earnBase">*Earn Base</option>
                    <option value="p25">25% (Senior Consultant)</option>
                    <option value="p35">35% (Qualified Producer)</option>
                    <option value="p42">42% (Success Builder)</option>
                    <option value="p50" selected>50% (Supervisor)</option>
                </select>
            </div>
            <!-- Markup -->
            <div class="ctrl-group">
                <label>ğŸ“ˆ Markup % on Buy Price</label>
                <span class="ctrl-notice">*Added on top of your buy price to set customer selling price</span>
                <input type="number" id="globalMarkup" value="0" min="0" step="0.01" oninput="onGlobalMarkupChange()">
            </div>
            <!-- Auto Mode -->
            <div class="ctrl-group">
                <label>ğŸ”„ Auto Markup Sync</label>
                <div class="automode-row">
                    <div class="automode-toggle" id="autoModeToggle" onclick="toggleAutoMode()"><div class="automode-slider"></div></div>
                    <span class="automode-status" id="autoModeStatus">OFF</span>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="productTable">
                <thead><tr>
                    <th style="width:230px">Product Name</th>
                    <th style="width:100px">MRP (â‚¹)</th>
                    <th style="width:110px">Buy Price (â‚¹) <span style="font-weight:400;font-size:10px">your level</span></th>
                    <th style="width:90px">Markup %</th>
                    <th style="width:110px">Sell Price (â‚¹)</th>
                    <th style="width:70px">Qty</th>
                    <th style="width:110px">Final Price (â‚¹)</th>
                    <th style="width:90px">Profit (â‚¹)</th>
                    <th style="width:60px">Del</th>
                </tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
            <button class="btn-add" onclick="addRow()">â• Add New Row</button>
        </div>
        <button class="btn-save" onclick="saveBill()">ğŸ’¾ Save Bill</button>
    </div>

    <div id="savedPage" class="page">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="ğŸ” Search bills by name..." oninput="searchBills()">
        </div>
        <div id="billsContainer" class="bills-container"></div>
    </div>

    <div id="summaryPage" class="page">
        <div class="summary-cards">
            <div class="summary-card"><h3>Total Bills</h3><div class="value" id="totalBills">0</div></div>
            <div class="summary-card"><h3>Total Products</h3><div class="value" id="totalProducts">0</div></div>
            <div class="summary-card"><h3>Total Revenue</h3><div class="value" id="totalRevenue">â‚¹0.00</div></div>
            <div class="summary-card"><h3>Total Profit</h3><div class="value" id="totalProfit">â‚¹0.00</div></div>
        </div>
        <div class="action-buttons">
            <button class="btn-export" onclick="exportCSV()">ğŸ“¥ Export CSV</button>
            <button class="btn-print" onclick="printSummary()">ğŸ–¨ï¸ Print Summary</button>
        </div>
    </div>
</div>

<div id="viewBillModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalBillTitle"></h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-billing-warning">âš ï¸ <em>*Saved bills may not reflect current or accurate calculations if distributor level, markup, or prices changed after this bill was generated.</em></div>
        <div id="modalBillItems"></div>
    </div>
</div>

<div class="watermark">Made by Vedant Suryawanshi</div>

<script>
// â”€â”€â”€ OFFICIAL HERBALIFE PRICE TABLE (from Associates Price List, 01-Nov-2025) â”€â”€
// Each entry: [MRP, retail, earnBase, p25, p35, p42, p50]
// Source: Herbalife International India Pvt. Ltd. official price list
const PRICE_TABLE = {
  // WEIGHT MANAGEMENT
  'formula 1 - nutritional shake mix - vanilla - 500 gms':        [2179,2075,1776,1713,1526,1396,1246],
  'formula 1 - nutritional shake mix - chocolate - 500 gms':      [2179,2075,1776,1713,1526,1396,1246],
  'formula 1 - nutritional shake mix - mango - 500 gms':          [2179,2075,1776,1713,1526,1396,1246],
  'formula 1 - nutritional shake mix - orange cream - 500 gms':   [2179,2075,1776,1713,1526,1396,1246],
  'formula 1 - nutritional shake mix - strawberry - 500 gms':     [2179,2075,1776,1713,1526,1396,1246],
  'formula 1 - nutritional shake mix - kulfi - 500 gms':          [2179,2075,1776,1713,1526,1396,1246],
  'formula 1 - nutritional shake mix - banana caramel - 500 gms': [2179,2075,1776,1713,1526,1396,1246],
  'formula 1 - nutritional shake mix - rose kheer - 500 gms':     [2179,2075,1776,1713,1526,1396,1246],
  'formula 1 nutritional shake mix - paan - 500 gms':             [2179,2075,1776,1713,1526,1396,1246],
  'formula 1 mango - 750 gms':      [3227,3073,2628,2537,2261,2068,1847],
  'formula 1 vanilla - 750 gms':    [3227,3073,2628,2537,2261,2068,1847],
  'formula 1 kulfi - 750 gms':      [3227,3073,2628,2537,2261,2068,1847],
  'formula 1 rose kheer - 750 gms': [3227,3073,2628,2537,2261,2068,1847],
  'personalized protein powder - 200 gms': [1295,1233,1054,1018,907,830,741],
  'personalized protein powder - 400 gms': [2485,2366,2023,1953,1741,1592,1422],
  'shakemate - 500 gms':            [653,621,531,572,540,517,491],
  // EYE HEALTH
  'liftoff watermelon (30 packets)': [4119,3922,3354,3238,2886,2639,2357],
  'ocular defense':                  [1927,1835,1570,1515,1350,1234,1103],
  // MEN'S HEALTH
  'male factor +':                   [3410,3247,2776,2681,2389,2185,1952],
  // WOMEN'S HEALTH
  "woman's choice":                  [1245,1185,1013,978,872,798,712],
  // BRAIN HEALTH
  'vritilife brain health - 60 tablets': [1464,1394,1192,1151,1026,938,838],
  // SKIN & BODY CARE
  'vritilife facial cleanser (100 ml)': [1165,987,844,916,816,746,667],
  'vritilife facial toner (100 ml)':    [1322,1120,958,1039,926,847,756],
  'vritilife facial serum (30 ml)':     [3022,2561,2190,2376,2118,1937,1730],
  'vritilife moisturizer (100 ml)':     [1473,1248,1067,1158,1032,944,843],
  'hn - skin booster - orange - 10gms * 30 sachets': [3910,3723,2749,3188,2899,2697,2466],
  'hn - skin booster canister':         [3910,3723,2849,3161,2862,2653,2413],
  // IMMUNITY
  'vritilife immune health - 60 tablets': [1528,1455,1245,1201,1070,979,874],
  // ENERGY
  'afresh energy drink mix - ginger - 50 gms':        [812,773,662,646,580,534,481],
  'afresh energy drink mix - elaichi - 50 gms':       [812,773,662,638,568,520,464],
  'afresh energy drink mix - lemon - 50 gms':         [812,773,662,638,568,520,464],
  'afresh energy drink mix - peach - 50 gms':         [812,773,662,638,568,520,464],
  'afresh energy drink mix - cinnamon - 50 gms':      [812,773,662,638,568,520,464],
  'afresh energy drink mix - kashmiri kahwa - 40 gms':[812,773,662,638,568,520,464],
  'afresh energy drink mix - tulsi (basil) - 50 gms': [812,773,630,646,580,534,481],
  // SPORTS
  'h24 hydrate - 5gms * 20 sachets':          [1636,1558,1333,1286,1146,1048,936],
  'h24 rebuild strength - 50gms * 10 sachets':[2616,2491,2035,2081,1868,1718,1547],
  // CHILDREN
  'dinoshake - chocolicious - 200 gms':                              [1115,1061,908,876,780,714,637],
  'dinoshake nutritional children\'s drink mix - strawberry - 200 gms':[1115,1061,908,876,780,714,637],
  // DIGESTIVE
  'activated fiber - 90 tablets':                      [1636,1558,1333,1286,1146,1048,936],
  'active fiber complex - unflavoured - 200 gms':      [2559,2437,2084,2012,1793,1640,1465],
  'aloe plus - 60 capsules':                           [1059,1008,863,832,741,678,605],
  'herbal aloe concentrate - unflavored (original) - 500 ml':[2696,2567,2195,2119,1889,1727,1543],
  'simply probiotic - 1gms * 30 sachets':              [2209,2103,1799,1736,1547,1415,1264],
  'vritilife triphala':                                [1089,1037,887,856,763,698,623],
  // BONE & JOINT
  'herbalife calcium tablets - 60 tablets': [1203,1145,979,945,842,771,688],
  'joint support - 90 tablets':             [2455,2338,2000,1930,1720,1573,1405],
  // CARDIOVASCULAR
  'herbalife niteworks - 300 gms': [7128,6788,5804,5604,4994,4568,4080],
  'herbalifeline - 60 softgels':   [2667,2540,2172,2097,1869,1709,1527],
  'beta heart - vanilla flavour - 15 gms * 15 sachets':[2242,2135,1576,1828,1663,1547,1414],
  // ENHANCERS
  'multivitamin mineral & herbal - 90 tablets':[2004,1908,1632,1575,1404,1284,1147],
  'sleep enhance':                             [1697,1616,1382,1334,1189,1087,971],
  // SLEEP SUPPORT
  'cell activator - new - 60 tablets':  [2215,2109,1804,1741,1551,1419,1267],
  'cell-u-loss advanced - 90 tablets':  [1705,1623,1388,1340,1194,1092,975],
  'herbal control - 90 tablets':        [3433,3269,2796,2699,2405,2199,1965],
};

// Level key â†’ index in PRICE_TABLE arrays
const LEVEL_IDX = {retail:1, earnBase:2, p25:3, p35:4, p42:5, p50:6};
const LEVEL_LABEL = {retail:'Retail Price', earnBase:'*Earn Base', p25:'25%', p35:'35%', p42:'42%', p50:'50%'};

// Normalize product name for lookup
function normName(s){
  if(!s) return '';
  return s.trim().toLowerCase()
    .replace(/[Â®â„¢â€“â€”]/g,'')
    .replace(/\s*-\s*/g,' - ')
    .replace(/\s+/g,' ')
    .replace(/500\s*gms/g,'500 gms')
    .replace(/750\s*gms/g,'750 gms');
}

function getPrices(productName){
  const key = normName(productName);
  if(PRICE_TABLE[key]) return PRICE_TABLE[key];
  // fuzzy: try contains
  for(const [k,v] of Object.entries(PRICE_TABLE)){
    if(key.includes(k) || k.includes(key)) return v;
  }
  // fuzzy: ignore special chars
  const strip = s => s.replace(/[^a-z0-9 ]/g,'').replace(/\s+/g,' ').trim();
  const sk = strip(key);
  for(const [k,v] of Object.entries(PRICE_TABLE)){
    if(strip(k) === sk) return v;
  }
  return null;
}

function getMRP(productName){ const p=getPrices(productName); return p?p[0]:null; }
function getBuyPrice(productName, level){ const p=getPrices(productName); return p?p[LEVEL_IDX[level]||6]:null; }

// Product categories list
const productCategories = {
  'WEIGHT MANAGEMENT': [
    'Formula 1 - Nutritional Shake Mix - Vanilla - 500 gms',
    'Formula 1 - Nutritional Shake Mix - Chocolate - 500 gms',
    'Formula 1 - Nutritional Shake Mix - Mango - 500 gms',
    'Formula 1 - Nutritional Shake Mix - Orange Cream - 500 gms',
    'Formula 1 - Nutritional Shake Mix - Strawberry - 500 gms',
    'Formula 1 - Nutritional Shake Mix - Kulfi - 500 gms',
    'Formula 1 - Nutritional Shake Mix - Banana Caramel - 500 gms',
    'Formula 1 - Nutritional Shake Mix - Rose Kheer - 500 gms',
    'Formula 1 Nutritional Shake Mix - Paan - 500 gms',
    'Formula 1 Mango - 750 gms','Formula 1 Vanilla - 750 gms',
    'Formula 1 Kulfi - 750 gms','Formula 1 Rose Kheer - 750 gms',
    'Personalized Protein Powder - 200 gms','Personalized Protein Powder - 400 gms',
    'ShakeMate - 500 gms'
  ],
  'EYE HEALTH': ['Ocular Defense','Liftoff Watermelon (30 Packets)'],
  "MEN'S HEALTH": ['Male Factor +'],
  "WOMEN'S HEALTH": ["Woman's Choice"],
  'BRAIN HEALTH': ['Vritilife Brain Health - 60 tablets'],
  'SKIN & BODY CARE': [
    'Vritilife Facial Cleanser (100 ml)','Vritilife Facial Toner (100 ml)',
    'Vritilife Moisturizer (100 ml)','Vritilife Facial Serum (30 ml)',
    'HN - Skin Booster Canister','HN - Skin Booster - Orange - 10gms * 30 Sachets'
  ],
  'IMMUNITY': ['Vritilife Immune Health - 60 tablets'],
  'ENERGY': [
    'Afresh Energy Drink Mix - Ginger - 50 gms','Afresh Energy Drink Mix - Elaichi - 50 gms',
    'Afresh Energy Drink Mix - Lemon - 50 gms','Afresh Energy Drink Mix - Peach - 50 gms',
    'Afresh Energy Drink Mix - Cinnamon - 50 gms','Afresh Energy Drink Mix - Kashmiri Kahwa - 40 gms',
    'Afresh Energy Drink Mix - Tulsi (Basil) - 50 gms'
  ],
  'SPORTS': ['H24 Hydrate - 5gms * 20 Sachets','H24 Rebuild Strength - 50gms * 10 Sachets'],
  'CHILDREN': [
    'DinoShake - Chocolicious - 200 gms',
    "Dinoshake Nutritional Children's Drink Mix - Strawberry - 200 gms"
  ],
  'DIGESTIVE': [
    'Activated Fiber - 90 tablets','Active Fiber Complex - Unflavoured - 200 gms',
    'Aloe Plus - 60 capsules','Herbal Aloe Concentrate - Unflavored (Original) - 500 ml',
    'Simply Probiotic - 1gms * 30 Sachets','Vritilife Triphala'
  ],
  'BONE & JOINT': ['Herbalife Calcium Tablets - 60 tablets','Joint Support - 90 tablets'],
  'CARDIOVASCULAR': [
    'Herbalife Niteworks - 300 gms','Herbalifeline - 60 softgels',
    'Beta Heart - Vanilla Flavour - 15 gms * 15 Sachets'
  ],
  'ENHANCERS': ['Multivitamin Mineral & Herbal - 90 tablets','Sleep Enhance'],
  'SLEEP SUPPORT': ['Cell Activator - New - 60 Tablets','Cell-U-Loss Advanced - 90 Tablets','Herbal Control - 90 Tablets']
};

// â”€â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let storage = {distributorName:'', bills:[], darkMode:false, distLevel:'p50', globalMarkup:0, autoMode:false};

function loadFromLocalStorage(){
  const s=localStorage.getItem('herbalifeStorage2');
  if(s) try{ storage=Object.assign({distLevel:'p50',globalMarkup:0,autoMode:false}, JSON.parse(s)); }catch(e){}
}
function saveToLocalStorage(){ localStorage.setItem('herbalifeStorage2', JSON.stringify(storage)); }

function getLevel(){ return document.getElementById('distLevel').value || 'p50'; }
function getGlobalMarkup(){ return parseFloat(document.getElementById('globalMarkup').value)||0; }

// â”€â”€â”€ CALCULATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// buyPrice = Herbalife's official price for distributor's level (GST-inclusive, fixed)
// sellPrice = buyPrice Ã— (1 + markup/100)   â€” what distributor charges customer
// finalPrice = sellPrice Ã— qty
// profit = (sellPrice - buyPrice) Ã— qty
function computeRow(buyPrice, markup, qty){
  const sellPrice  = buyPrice * (1 + markup / 100);
  const finalPrice = sellPrice * qty;
  const profit     = (sellPrice - buyPrice) * qty;
  return {sellPrice, finalPrice, profit};
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init(){
  loadFromLocalStorage();
  loadDistributorName();
  loadDarkMode();
  document.getElementById('distLevel').value = storage.distLevel || 'p50';
  document.getElementById('globalMarkup').value = storage.globalMarkup || 0;
  if(storage.autoMode){
    document.getElementById('autoModeToggle').classList.add('active');
    document.getElementById('autoModeStatus').textContent = 'ON';
  }
  loadBills();
  for(let i=0;i<5;i++) addRow();
}

function loadDistributorName(){
  if(storage.distributorName){
    document.getElementById('distributorName').value = storage.distributorName;
    document.getElementById('currentDistributor').innerHTML = `Current Distributor: <strong>${storage.distributorName}</strong>`;
  }
}

document.addEventListener('DOMContentLoaded', function(){
  const d = document.getElementById('distributorName');
  if(d){ d.addEventListener('change', function(){
    storage.distributorName = this.value.trim(); saveToLocalStorage();
    document.getElementById('currentDistributor').innerHTML = `Current Distributor: <strong>${storage.distributorName}</strong>`;
    showSuccess('Distributor name saved!');
  });}
});

function toggleDarkMode(){
  document.getElementById('darkModeToggle').classList.toggle('active');
  document.body.classList.toggle('dark-mode');
  storage.darkMode = document.body.classList.contains('dark-mode');
  saveToLocalStorage();
}
function loadDarkMode(){
  if(storage.darkMode){ document.body.classList.add('dark-mode'); document.getElementById('darkModeToggle').classList.add('active'); }
}

// â”€â”€â”€ LEVEL / MARKUP CHANGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onLevelChange(){
  storage.distLevel = getLevel(); saveToLocalStorage();
  refreshAllBuyPrices();
  showBillingWarning();
}

function onGlobalMarkupChange(){
  storage.globalMarkup = getGlobalMarkup(); saveToLocalStorage();
  if(storage.autoMode){ syncMarkupToAllRows(); }
  showBillingWarning();
}

function toggleAutoMode(){
  const tog = document.getElementById('autoModeToggle');
  const st  = document.getElementById('autoModeStatus');
  tog.classList.toggle('active');
  storage.autoMode = tog.classList.contains('active');
  st.textContent = storage.autoMode ? 'ON' : 'OFF';
  saveToLocalStorage();
  if(storage.autoMode) syncMarkupToAllRows();
}

function syncMarkupToAllRows(){
  const mk = getGlobalMarkup();
  document.querySelectorAll('#tableBody tr').forEach(r=>{
    r.querySelector('.markup').value = mk;
    calculateRow(r);
  });
}

function refreshAllBuyPrices(){
  const level = getLevel();
  document.querySelectorAll('#tableBody tr').forEach(r=>{
    const name = r.querySelector('.product-name').value.trim();
    const bp = getBuyPrice(name, level);
    const bpInput = r.querySelector('.buy-price');
    if(bp !== null){ bpInput.value = bp.toFixed(2); bpInput.classList.add('auto-filled'); }
    calculateRow(r);
  });
}

// â”€â”€â”€ ADD ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addRow(){
  const t = document.getElementById('tableBody');
  const r = t.insertRow();
  const i = t.rows.length - 1;
  r.innerHTML = `
    <td><div class="product-input-wrapper">
      <input type="text" class="product-name" placeholder="Type or click â–¼" data-row="${i}">
      <button class="product-dropdown-btn" onclick="toggleDropdown(event,${i})">â–¼</button>
      <div class="product-dropdown" id="dropdown-${i}"></div>
    </div></td>
    <td><input type="number" class="mrp-display" readonly placeholder="â€”" style="background:#f9f9f9;color:#888"></td>
    <td><input type="number" class="buy-price" placeholder="Auto-fills" step="0.01" oninput="onBuyPriceInput(this)"></td>
    <td><input type="number" class="markup" placeholder="0" step="0.01" value="${storage.globalMarkup||0}" oninput="onMarkupInput(this)"></td>
    <td><input type="number" class="sell-price" readonly></td>
    <td><input type="number" class="quantity" value="1" min="1" step="1" oninput="calculateRow(this.closest('tr'))"></td>
    <td><input type="number" class="final-price" readonly></td>
    <td><input type="number" class="profit-display" readonly></td>
    <td><button class="btn-delete" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>`;

  buildDropdown(i);
}

function buildDropdown(i){
  const drop = document.getElementById(`dropdown-${i}`);
  const level = getLevel();
  let html = '';
  for(const [cat, prods] of Object.entries(productCategories)){
    html += `<div class="product-category">${cat}</div>`;
    prods.forEach(p=>{
      const prices = getPrices(p);
      const mrpTag  = prices ? `<span class="price-tag mrp">MRP â‚¹${prices[0]}</span>` : '';
      const buyTag  = prices ? `<span class="price-tag">Buy â‚¹${prices[LEVEL_IDX[level]||6]}</span>` : '';
      html += `<div class="product-item" onclick="selectProduct('${p.replace(/'/g,"\\'")}',${i})">
        <span>${p}</span>
        <div class="product-item-prices">${mrpTag}${buyTag}</div>
      </div>`;
    });
  }
  drop.innerHTML = html;
}

function toggleDropdown(e, i){
  e.preventDefault();
  const d = document.getElementById(`dropdown-${i}`);
  d.classList.toggle('active');
  document.querySelectorAll('.product-dropdown').forEach(x=>{ if(x.id!==`dropdown-${i}`) x.classList.remove('active'); });
}

function selectProduct(p, i){
  const nameInput = document.querySelector(`input[data-row="${i}"]`);
  nameInput.value = p;
  document.getElementById(`dropdown-${i}`).classList.remove('active');
  const row = nameInput.closest('tr');
  const level = getLevel();
  const prices = getPrices(p);
  if(prices){
    row.querySelector('.mrp-display').value = prices[0].toFixed(2);
    const bp = prices[LEVEL_IDX[level]||6];
    const bpInput = row.querySelector('.buy-price');
    bpInput.value = bp.toFixed(2);
    bpInput.classList.add('auto-filled');
    calculateRow(row);
    showSuccess(`âœ… ${p} â€” Buy â‚¹${bp} (${LEVEL_LABEL[level]})`);
  } else {
    row.querySelector('.mrp-display').value = '';
    row.querySelector('.buy-price').value = '';
    row.querySelector('.buy-price').classList.remove('auto-filled');
    showSuccess(`Product selected â€” enter buy price manually`);
  }
}

// Live search in dropdown
document.addEventListener('input', function(e){
  if(!e.target.classList.contains('product-name')) return;
  const i = e.target.getAttribute('data-row');
  const d = document.getElementById(`dropdown-${i}`);
  const q = e.target.value.toLowerCase();
  if(q.length > 0){
    let any = false;
    d.querySelectorAll('.product-item').forEach(item=>{
      const name = item.querySelector('span') ? item.querySelector('span').textContent : item.textContent;
      const show = name.toLowerCase().includes(q);
      item.style.display = show ? 'flex' : 'none';
      if(show) any = true;
    });
    d.querySelectorAll('.product-category').forEach(cat=>{
      let next = cat.nextElementSibling; let vis = false;
      while(next && !next.classList.contains('product-category')){ if(next.style.display!=='none') vis=true; next=next.nextElementSibling; }
      cat.style.display = vis ? 'block' : 'none';
    });
    if(any) d.classList.add('active');
  } else {
    d.querySelectorAll('.product-item,.product-category').forEach(x=>x.style.display='');
    d.classList.remove('active');
  }
});

function onBuyPriceInput(input){
  input.classList.remove('auto-filled');
  calculateRow(input.closest('tr'));
}

function onMarkupInput(input){
  if(storage.autoMode){
    const v = parseFloat(input.value)||0;
    document.getElementById('globalMarkup').value = v;
    storage.globalMarkup = v; saveToLocalStorage();
    document.querySelectorAll('#tableBody tr').forEach(r=>{ r.querySelector('.markup').value=v; calculateRow(r); });
  } else {
    calculateRow(input.closest('tr'));
  }
  showBillingWarning();
}

function calculateRow(row){
  const bp  = parseFloat(row.querySelector('.buy-price').value)||0;
  const mk  = parseFloat(row.querySelector('.markup').value)||0;
  const qty = parseInt(row.querySelector('.quantity').value)||1;
  if(bp === 0){ row.querySelector('.sell-price').value=''; row.querySelector('.final-price').value=''; row.querySelector('.profit-display').value=''; return; }
  const {sellPrice, finalPrice, profit} = computeRow(bp, mk, qty);
  row.querySelector('.sell-price').value  = sellPrice.toFixed(2);
  row.querySelector('.final-price').value = finalPrice.toFixed(2);
  row.querySelector('.profit-display').value = profit.toFixed(2);
}

function deleteRow(btn){ if(confirm('Delete this row?')) btn.closest('tr').remove(); }

// â”€â”€â”€ BILLING WARNING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showBillingWarning(){
  if(!document.getElementById('globalBillingWarning')){
    const el = document.createElement('div');
    el.id = 'globalBillingWarning';
    el.className = 'billing-warning';
    el.innerHTML = 'âš ï¸ <em>*Saved bills may not reflect current or accurate calculations if distributor level, markup, or prices changed after the bill was generated.</em>';
    const bc = document.getElementById('billsContainer');
    if(bc && bc.parentNode) bc.parentNode.insertBefore(el, bc);
  }
}

// â”€â”€â”€ SAVE BILL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveBill(){
  const bn = document.getElementById('billName').value.trim();
  const dn = document.getElementById('distributorName').value.trim();
  if(!bn){ alert('Enter bill name'); return; }
  if(!dn){ alert('Enter distributor name'); return; }
  storage.distributorName = dn; saveToLocalStorage();

  const level = getLevel();
  const rows  = document.querySelectorAll('#tableBody tr');
  const prods = [];
  rows.forEach(r=>{
    const name = r.querySelector('.product-name').value.trim();
    if(!name) return;
    const mrp   = parseFloat(r.querySelector('.mrp-display').value)||0;
    const bp    = parseFloat(r.querySelector('.buy-price').value)||0;
    const mk    = parseFloat(r.querySelector('.markup').value)||0;
    const qty   = parseInt(r.querySelector('.quantity').value)||1;
    const sell  = parseFloat(r.querySelector('.sell-price').value)||0;
    const fp    = parseFloat(r.querySelector('.final-price').value)||0;
    const prf   = parseFloat(r.querySelector('.profit-display').value)||0;
    if(bp === 0) return;
    prods.push({name, mrp, buyPrice:bp, markup:mk, quantity:qty, sellPrice:sell, finalPrice:fp, profit:prf, level});
  });
  if(!prods.length){ alert('Add at least one product with a buy price'); return; }

  const bill = {
    id: Date.now(), name: bn, distributor: dn,
    products: prods, level, levelLabel: LEVEL_LABEL[level],
    savedDate: new Date().toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'}),
    timestamp: Date.now()
  };
  storage.bills.push(bill); saveToLocalStorage();
  showSuccess('âœ… Bill saved!');
  document.getElementById('billName').value = '';
  document.getElementById('tableBody').innerHTML = '';
  for(let i=0;i<5;i++) addRow();
  loadBills(); updateSummary();
}

// â”€â”€â”€ LOAD BILLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadBills(){
  const bills = storage.bills || [];
  const c = document.getElementById('billsContainer');
  if(!bills.length){ c.innerHTML='<div class="empty-state"><h2>No bills saved yet</h2></div>'; return; }
  const warn = `<div class="billing-warning">âš ï¸ <em>*Saved bills may not reflect current calculations if distributor level, markup, or prices changed after generation.</em></div>`;
  c.innerHTML = warn + bills.map(b=>{
    const totalRev  = b.products.reduce((s,p)=>s+p.finalPrice,0);
    const totalProf = b.products.reduce((s,p)=>s+p.profit,0);
    return `<div class="bill-card" data-name="${b.name.toLowerCase()}">
      <div class="bill-header">
        <div>
          <h3 style="margin:0;color:var(--dark-green)">${b.name}</h3>
          <div class="bill-date">ğŸ“… ${b.savedDate} &nbsp;|&nbsp; ğŸ·ï¸ Level: <strong>${b.levelLabel||b.level||'â€”'}</strong></div>
        </div>
        <div class="bill-actions">
          <button class="btn-view" onclick="viewBill(${b.id})">ğŸ‘ï¸ View</button>
          <button class="btn-download" onclick="downloadBill(${b.id})">ğŸ“¥ PDF</button>
          <button class="btn-delete-bill" onclick="deleteBill(${b.id})">ğŸ—‘ï¸ Delete</button>
        </div>
      </div>
      <div class="bill-items">${b.products.map(p=>`
        <div class="bill-item">
          <div class="bill-item-name">${p.name}</div>
          <div style="display:flex;gap:16px;font-size:12px">
            <span>Qty: ${p.quantity}</span>
            <span>Buy: â‚¹${p.buyPrice.toFixed(2)}</span>
            <span>Sell: â‚¹${p.finalPrice.toFixed(2)}</span>
          </div>
        </div>`).join('')}
      </div>
      <div class="bill-summary">
        <div class="bill-summary-row"><span>Items:</span><span>${b.products.length}</span></div>
        <div class="bill-summary-row"><span>Total Revenue:</span><span>â‚¹${totalRev.toFixed(2)}</span></div>
        <div class="bill-summary-row"><span>Total Profit:</span><span>${totalProf>=0?'â‚¹'+totalProf.toFixed(2):'<span class="loss-value">Loss: â‚¹'+Math.abs(totalProf).toFixed(2)+'</span>'}</span></div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€ VIEW BILL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function viewBill(id){
  const b = storage.bills.find(x=>x.id===id); if(!b) return;
  document.getElementById('modalBillTitle').textContent = `${b.name} â€” ${b.savedDate}`;
  document.getElementById('modalBillItems').innerHTML = b.products.map(p=>{
    const isLoss = p.profit < 0;
    return `<div class="modal-bill-item">
      <h4>${p.name}</h4>
      <div class="item-detail"><span>MRP:</span><strong>â‚¹${(p.mrp||0).toFixed(2)}</strong></div>
      <div class="item-detail"><span>Distributor Level:</span><strong>${b.levelLabel||b.level||'â€”'}</strong></div>
      <div class="item-detail"><span>Buy Price (your cost):</span><strong>â‚¹${p.buyPrice.toFixed(2)}</strong></div>
      <div class="item-detail"><span>Markup:</span><strong>${p.markup.toFixed(2)}%</strong></div>
      <div class="item-detail"><span>Sell Price / unit:</span><strong style="color:#8BC34A">â‚¹${p.sellPrice.toFixed(2)}</strong></div>
      <div class="item-detail"><span>Qty:</span><strong>${p.quantity}</strong></div>
      <div class="item-detail"><span>Final Total:</span><strong style="color:#8BC34A">â‚¹${p.finalPrice.toFixed(2)}</strong></div>
      <div class="item-detail"><span>Profit / Loss:</span><strong style="color:${isLoss?'#d32f2f':'#689F38'}">${isLoss?'Loss':'Profit'}: â‚¹${Math.abs(p.profit).toFixed(2)}</strong></div>
    </div>`;
  }).join('');
  document.getElementById('viewBillModal').classList.add('active');
}

function closeModal(){ document.getElementById('viewBillModal').classList.remove('active'); }

// â”€â”€â”€ DOWNLOAD PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadBill(id){
  const b = storage.bills.find(x=>x.id===id); if(!b) return;
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 15;
  const colW = pageW - margin*2;
  let y = margin;

  // Header
  doc.setFillColor(139,195,74); doc.rect(0,0,pageW,28,'F');
  doc.setTextColor(255,255,255); doc.setFontSize(18); doc.setFont('helvetica','bold');
  doc.text('Herbalife Bill', margin, 11);
  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text('Herbalife Distributor Pricing App', margin, 18);
  doc.text('Made by Vedant Suryawanshi', pageW-margin, 18, {align:'right'});
  y = 35;

  // Meta
  doc.setTextColor(30,30,30); doc.setFontSize(16); doc.setFont('helvetica','bold');
  doc.text(b.name, margin, y); y += 7;
  doc.setFontSize(10); doc.setFont('helvetica','normal'); doc.setTextColor(100,100,100);
  doc.text(`Date: ${b.savedDate}  |  Level: ${b.levelLabel||b.level}  |  Distributor: ${b.distributor||'N/A'}`, margin, y);
  y += 5;

  // Warning box
  doc.setFillColor(255,248,225); doc.setDrawColor(255,224,82);
  doc.rect(margin, y, colW, 8, 'FD');
  doc.setTextColor(122,96,0); doc.setFontSize(7.5); doc.setFont('helvetica','italic');
  doc.text('*Saved bills may not reflect accurate calculations if distributor level or markup changed after bill was generated.', margin+2, y+5.5, {maxWidth:colW-4});
  y += 11;

  // Divider
  doc.setDrawColor(139,195,74); doc.setLineWidth(0.5);
  doc.line(margin, y, pageW-margin, y); y += 6;

  // Table header
  const cols = [
    {label:'#',          w:8},
    {label:'Product',    w:65},
    {label:'MRP (â‚¹)',    w:20},
    {label:'Buy (â‚¹)',    w:22},
    {label:'Markup%',    w:18},
    {label:'Sell/unit',  w:22},
    {label:'Qty',        w:10},
    {label:'Total (â‚¹)',  w:22},
  ];
  doc.setFillColor(104,159,56); doc.rect(margin, y, colW, 8, 'F');
  doc.setTextColor(255,255,255); doc.setFontSize(9); doc.setFont('helvetica','bold');
  let cx = margin+2;
  cols.forEach(c=>{ doc.text(c.label, cx, y+5.5); cx+=c.w; });
  y += 8;

  doc.setFont('helvetica','normal');
  b.products.forEach((p,idx)=>{
    const rowH = 10;
    if(y+rowH > pageH-35){
      doc.addPage(); y=margin;
      doc.setFillColor(104,159,56); doc.rect(margin,y,colW,8,'F');
      doc.setTextColor(255,255,255); doc.setFontSize(9); doc.setFont('helvetica','bold');
      let hx=margin+2; cols.forEach(c=>{ doc.text(c.label,hx,y+5.5); hx+=c.w; });
      y+=8; doc.setFont('helvetica','normal');
    }
    if(idx%2===0){ doc.setFillColor(240,248,230); doc.rect(margin,y,colW,rowH,'F'); }
    doc.setTextColor(30,30,30); doc.setFontSize(8.5);
    let name=p.name;
    const maxW=cols[1].w-2;
    while(doc.getTextWidth(name)>maxW && name.length>5) name=name.slice(0,-1);
    if(name!==p.name) name=name.slice(0,-1)+'â€¦';
    const row=[String(idx+1), name, (p.mrp||0).toFixed(2), p.buyPrice.toFixed(2), p.markup.toFixed(2)+'%', p.sellPrice.toFixed(2), String(p.quantity), p.finalPrice.toFixed(2)];
    cx=margin+2; row.forEach((v,vi)=>{ doc.text(v,cx,y+6.5); cx+=cols[vi].w; });
    doc.setDrawColor(220,220,220); doc.setLineWidth(0.2); doc.line(margin,y+rowH,margin+colW,y+rowH);
    y+=rowH;
  });

  // Summary
  y+=4; doc.setDrawColor(139,195,74); doc.setLineWidth(0.6); doc.line(margin,y,pageW-margin,y); y+=6;
  const totalRev  = b.products.reduce((s,p)=>s+p.finalPrice,0);
  const totalProf = b.products.reduce((s,p)=>s+p.profit,0);
  const sx = pageW-margin-70;
  doc.setFontSize(10); doc.setFont('helvetica','bold'); doc.setTextColor(50,50,50);
  doc.text('Total Items:', sx, y); doc.setFont('helvetica','normal'); doc.text(`${b.products.length}`, pageW-margin, y, {align:'right'}); y+=7;
  doc.setFont('helvetica','bold'); doc.text('Total Revenue:', sx, y); doc.setFont('helvetica','normal'); doc.text(`Rs.${totalRev.toFixed(2)}`, pageW-margin, y, {align:'right'}); y+=7;
  const isLoss = totalProf < 0;
  doc.setFont('helvetica','bold'); doc.setTextColor(isLoss?211:69, isLoss?47:160, isLoss?47:56);
  doc.text(isLoss?'Total Loss:':'Total Profit:', sx, y); doc.setFont('helvetica','normal');
  doc.text(`Rs.${Math.abs(totalProf).toFixed(2)}`, pageW-margin, y, {align:'right'}); y+=10;

  // Footer
  doc.setFontSize(8); doc.setTextColor(160,160,160); doc.setFont('helvetica','italic');
  doc.text(`Generated on ${new Date().toLocaleString()}`, margin, pageH-8);
  doc.text('Made by Vedant Suryawanshi', pageW-margin, pageH-8, {align:'right'});

  const filename = `${b.name.replace(/[^a-zA-Z0-9_\- ]/g,'').trim().replace(/\s+/g,'_')}.pdf`;
  doc.save(filename);
  showSuccess(`ğŸ“„ "${b.name}.pdf" downloaded!`);
}

// â”€â”€â”€ SEARCH / DELETE / SUMMARY / EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function searchBills(){
  const q = document.getElementById('searchInput').value.toLowerCase();
  document.querySelectorAll('.bill-card').forEach(c=>{ c.style.display = c.getAttribute('data-name').includes(q)?'block':'none'; });
}

function deleteBill(id){
  if(!confirm('Delete this bill?')) return;
  storage.bills = storage.bills.filter(b=>b.id!==id);
  saveToLocalStorage(); loadBills(); updateSummary(); showSuccess('Deleted!');
}

function updateSummary(){
  const bills = storage.bills||[];
  const all   = bills.flatMap(b=>b.products);
  document.getElementById('totalBills').textContent    = bills.length;
  document.getElementById('totalProducts').textContent = all.length;
  const tr = all.reduce((s,p)=>s+p.finalPrice,0);
  const tp = all.reduce((s,p)=>s+p.profit,0);
  document.getElementById('totalRevenue').textContent = `â‚¹${tr.toFixed(2)}`;
  document.getElementById('totalProfit').textContent  = tp>=0 ? `â‚¹${tp.toFixed(2)}` : `Loss: â‚¹${Math.abs(tp).toFixed(2)}`;
}

function exportCSV(){
  const bills = storage.bills||[];
  if(!bills.length){ alert('No bills to export'); return; }
  let csv = 'Bill,Date,Level,Product,MRP,BuyPrice,Markup%,SellPrice,Qty,FinalPrice,Profit\n';
  bills.forEach(b=>{
    b.products.forEach(p=>{
      csv += `"${b.name}","${b.savedDate}","${b.levelLabel||b.level}","${p.name}",${p.mrp||0},${p.buyPrice},${p.markup},${p.sellPrice},${p.quantity},${p.finalPrice},${p.profit}\n`;
    });
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a'); a.href=url;
  a.download = `herbalife_bills_${new Date().toISOString().split('T')[0]}.csv`;
  a.click(); URL.revokeObjectURL(url);
}

function printSummary(){ window.print(); }

function showPage(p){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  if(p==='input'){ document.getElementById('inputPage').classList.add('active'); document.querySelectorAll('.nav-btn')[0].classList.add('active'); }
  else if(p==='saved'){ document.getElementById('savedPage').classList.add('active'); document.querySelectorAll('.nav-btn')[1].classList.add('active'); loadBills(); }
  else { document.getElementById('summaryPage').classList.add('active'); document.querySelectorAll('.nav-btn')[2].classList.add('active'); updateSummary(); }
}

function showSuccess(m){
  const el = document.createElement('div'); el.className='success-message'; el.textContent=m;
  document.body.appendChild(el); setTimeout(()=>el.remove(), 3000);
}

init();
</script>
</body>
</html>
